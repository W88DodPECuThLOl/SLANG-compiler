# SLANG-compiler
SLANG Compiler (Z80) 0.0.2

# 概要

これは主に国産8bit PCで使われたOS「S-OS」オリジナルの構造型コンパイラ言語「SLANG」のクロスコンパイラです。

コンパイルする事で、Z80のアセンブラソースを出力するため、柔軟な活用が可能です。

現状、LSX-Dodgersで動作するように作られていますが、OS依存部分を個々作る事で、CPUにZ80を採用している様々な環境で動かす事が出来るはずです。

# 使い方

まだ作り途中なのであちこち怪しいです。

```
SLANGCompiler filename [-L library-name] [-O output-path]

SLANG Compiler 0.0.2
Copyright (c) 2022 OGINO Hiroshi / H.O SOFT

  -L, --lib               Library name(s). ( lib*.yml )
  -O, --output            Output file path.
  --help                  Display this help screen.
  --version               Display version information.
```

コマンドラインにSLANGのソースファイル(拡張子は通常は .SL )を渡す事で、ソースファイルの拡張子を .ASM にしたアセンブラソースが出力されます(-O オプションにファイル名を渡すと、そちらに出力されます)。

アセンブラソースは、Z80アセンブラ [AILZ80ASM](https://github.com/AILight/AILZ80ASM) でアセンブル出来るものが出力されますので、適宜ご利用ください。

-L オプションに続けて、後述のランタイムライブラリの名前を付与する事で、指定のライブラリを読み込む事が出来ます( -L x1 とする事で、 libx1.yml というライブラリを読み込みます)。

# ランタイムについて

SLANG Compilerはランタイムライブラリとして、複数のファイルを読み込む事が出来ます。

## runtime.yml (OS依存しないライブラリ)
何も指定しなくても読み込まれるランタイムライブラリです。

こちらは、一般的なZ80の環境であれば実行出来るライブラリコードが含まれるファイルです。

例えば掛け算や割り算など、OSなどの環境に関わらないルーチンはこちらに含まれています。普通のYAML形式のテキストファイルなので、
より高速なものに自分で差し替える事も可能です(というか、いいコードが出来たらプルリクください)。

##  lib.yml (for LSX-Dodgers)
こちらは、ライブラリのうち、OSに依存するルーチンが含まれるものとなります。
現状X1/turbo/ZやMZ-700/1500やPC-8801mkIISRでCP/M80やMSX-DOSのソフトを実行するためのOS [LSX-Dodgers](https://github.com/tablacus/LSX-Dodgers) 用のコードになっています(初期化処理やPRINT、LOCATEなど)。

このコードを各環境(各機種、各OS)向けに書き換える事で、様々な環境でSLANGを使ったプログラムを動かす事が出来ます。

-L オプションに何も指定しない場合はこのファイルが読み込まれます。

## libx1.yml (for SHARP X1)
こちらはLSX-Dodgers版をベースに、WIDTH関数とPRINT関数のみX1専用に書き換えたランタイムライブラリとなります。

-L x1 とオプションを付与する事で、lib.ymlのかわりにこちらを読み込みます。

現状、WIDTH(40)、WIDTH(80)の指定が可能となり、PRINT文が高速化されます(そのかわりいくつかの機能が無効になります)。


## ランタイムのパスについて
runtime.yml と lib*.ymlは、カレントパス、あるいはユーザーフォルダの .config/SLANG/ フォルダの下から読まれます。環境により、適宜配置してください。

## ランタイムの記述ルール(書き途中)

- param_countにパラメータの数を入れてください
  - パラメータは3個までの場合はレジスタ渡しされます(HL、DE、BCの順)。
  - 4個以上の場合は全てIYレジスタをポインタとして適宜渡されます(SLANGの仕様を確認してください)
- callsに、このルーチンが呼び出すランタイムの名称を記述してください
- codeに、コード本体を書いてください。インデントは変えないでください。

# ライセンス
MIT

# 更新履歴
- Version 0.0.2
  - 符号反転(NEGHL)が正常に機能しない問題を修正
  - 減算処理が正常に機能しない事がある問題を修正
  - コマンドラインオプションをザッと実装
  - X1用ランタイムを追加(まだ仮)
- Version 0.0.1
  - 初版
  - 多分バグだらけ(特に配列や間接変数など全般が怪しいです)
