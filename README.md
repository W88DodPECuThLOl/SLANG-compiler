# SLANG-compiler
SLANG Compiler (Z80) 0.2.0

# 概要

これは主に国産8bit PCで使われたOS「S-OS」オリジナルの構造型コンパイラ言語「SLANG」のクロスコンパイラです。

コンパイルする事で、Z80のアセンブラソースを出力するため、柔軟な活用が可能です。

現状、LSX-Dodgers及びS-OSで動作するように作られていますが、OS依存部分を個々作る事で、CPUにZ80を採用している様々な環境で動かす事が出来るはずです。

# 使い方

まだ作り途中なのであちこち怪しいです。

```
SLANGCompiler filename [-L library-name] [-O output-path]

SLANG Compiler 0.1.0
Copyright (c) 2022 OGINO Hiroshi / H.O SOFT

  -L, --lib               Library name(s). ( lib*.yml )
  -O, --output            Output file path.
  --use-symbol            Use original symbol name.
  --case-sensitive        Set symbols to be case-sensitive.
  --help                  Display this help screen.
  --version               Display version information.
```

コマンドラインにSLANGのソースファイル(拡張子は通常は .SL )を渡す事で、ソースファイルの拡張子を .ASM にしたアセンブラソースが出力されます(-O オプションにファイル名を渡すと、そちらに出力されます)。

アセンブラソースは、Z80アセンブラ [AILZ80ASM](https://github.com/AILight/AILZ80ASM) でアセンブル出来るものが出力されますので、適宜ご利用ください。

-L オプションに続けて、後述のランタイムライブラリの名前を付与する事で、指定のライブラリを読み込む事が出来ます( -L x1 とする事で、 libx1.yml というライブラリを読み込みます)。

--use-symbol をつけると、変数名、関数名について、ソースコードで利用した名前をそのまま使ってアセンブラソースが出力されます。つけない場合は、「SYM(数字)」という名前に置き換えられますので、アセンブラがラベルとして識別出来ない変数名、関数名を使っている場合は、--use-symbolをつけないようにしてください。

--case-sensitiveをつけると、識別子について大文字小文字が区別されます。つけない場合は区別されません。

# ランタイムについて

SLANG Compilerはランタイムライブラリとして、複数のファイルを読み込む事が出来ます。

## runtime.yml (OS依存しないライブラリ)
何も指定しなくても読み込まれるランタイムライブラリです。

こちらは、一般的なZ80の環境であれば実行出来るライブラリコードが含まれるファイルです。

例えば掛け算や割り算など、OSなどの環境に関わらないルーチンはこちらに含まれています。普通のYAML形式のテキストファイルなので、
より高速なものに自分で差し替える事も可能です(というか、いいコードが出来たらプルリクください)。

##  lib.yml / liblsx.yml (for LSX-Dodgers/MSX-DOS(2))
こちらは、ライブラリのうち、OSに依存するルーチンが含まれるものとなります。
現状X1/turbo/ZやMZ-700/1500やPC-8801mkIISRでCP/M80やMSX-DOSのソフトを実行するためのOS [LSX-Dodgers](https://github.com/tablacus/LSX-Dodgers) 用のコードになっています(初期化処理やPRINT、LOCATEなど)。

このコードを各環境(各機種、各OS)向けに書き換える事で、様々な環境でSLANGを使ったプログラムを動かす事が出来ます。

-L オプションに何も指定しない場合はこのファイルが読み込まれます。

また、明示的に -L lsx を指定する事で liblsx.yml が読み込まれますが、lib.ymlとliblsx.ymlはほぼ同じ内容となっています。

liblsx.ymlではファイルオープンの際のMSX-DOS2の処理を省略しています。

## libx1.yml (for SHARP X1)
こちらはLSX-Dodgers版をベースに、WIDTH関数とPRINT関数のみX1専用に書き換えたランタイムライブラリとなります。

-L x1 とオプションを付与する事で、lib.ymlのかわりにこちらを読み込みます。

現状、WIDTH(40)、WIDTH(80)の指定が可能となり、PRINT文が高速化されます(そのかわりいくつかの機能が無効になります)。

## libsos.yml (for S-OS)
S-OS版のランタイムです。これを読み込む事で、従来のSLANGで作られたアプリをコンパイルし、S-OSで実行出来ます。

-L sos とオプションを付与する事で、lib.ymlのかわりにこちらを読み込みます。

## libmsx2.yml (for MSX-DOS2)
こちらは、ライブラリのうち、OSに依存するルーチンが含まれるものとなります。
lib.ymlをベースにファイル入出力ライブラリをファイルハンドルを用いたものに差し替えています。
lib.ymlでもMSX-DOS2であればファイル入出力ライブラリが使えますが、FCBを用いているためにMSX-DOS2ではカレントデディレクトリにしか対応していないので、サブディレクトリを使う場合はこちらを使用してください。


## ランタイムのパスについて
runtime.yml と lib*.ymlは、カレントパス、あるいはユーザーフォルダの .config/SLANG/ フォルダの下から読まれます。環境により、適宜配置してください。

## ランタイムの記述ルール(書き途中)

- param_countにパラメータの数を入れてください
  - パラメータは3個までの場合はレジスタ渡しされます(HL、DE、BCの順)。
  - 4個以上の場合は全てIYレジスタをポインタとして適宜渡されます(SLANGの仕様を確認してください)
- callsに、このルーチンが呼び出すランタイムの名称を記述してください
- codeに、コード本体を書いてください。インデントは変えないでください。

# ライセンス
MIT

# 更新履歴
- Version 0.2.0
  - CONSTにCODEリストを与える事が出来るよう対応
  - MACHINE関数について定義のみで実装出来なかった不具合を修正
  - 変数宣言のアドレス指定にCODEアドレスを持つCONST値を指定出来るよう対応
  - CONST関連の処理を見直し
  - ^CARRYと^CYを同じものとして扱うよう対応
  - 関数名と変数名についてデフォルトで大文字小文字を区別しないよう変更(--case-sensitiveオプションの追加)
  - 「!」をBYTEの別名として扱うよう対応
  - プリプロセッサ命令の一部を大文字小文字区別しないよう対応
  - CONST定義にランタイム(ラベル)を指定出来るよう対応
  - LOOP文(無限ループ)に対応
  - 間接変数の二次元配列に対応
  - EXIT(num)でnum個ぶんループを抜けられるよう対応(numは定数である必要があります)
  - 不正なランタイム関数名の内部名称の変更(BIT/SET)
  - examplesフォルダ追加
  - 0x〜で16進数として扱われるよう対応
  - CASE文の中からEXITで抜けられなかったのを修正
- Version 0.1.0
  - --use-symbolオプションを追加
  - 配列の初期化をCODEリストで行うよう修正
  - プリプロセッサのIFの定数評価の仕組みを調整
  - OFFSET文対応(無視されます)
  - ソースファイルの文字コードを自動判別するよう対応
  - 出力されるアセンブラソースをShiftJIS固定に(どうするか検討中。このままかも)
  - CODE項についてアドレス値とその加算の構文に対応( (配列名)+1 で、配列+1のアドレスを埋め込むような対応)
  - ELSEIFを追加
  - 二次元配列の初期化が出来ない問題を修正
  - MACHINE関数呼び出しの引数設定がおかしくなる事がある問題の修正
  - SGNが正常に動作しないバグを修正
  - OS非依存ランタイムをruntime.ymlに移動
  - 通常関数呼び出し時にパラメータが正しく渡らない事がある問題を修正 
- Version 0.0.2
  - 符号反転(NEGHL)が正常に機能しない問題を修正
  - 減算処理が正常に機能しない事がある問題を修正
  - コマンドラインオプションをザッと実装
  - X1用ランタイムを追加(まだ仮)
- Version 0.0.1
  - 初版
  - 多分バグだらけ(特に配列や間接変数など全般が怪しいです)
