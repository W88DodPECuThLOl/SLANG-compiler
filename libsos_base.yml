
SLANGINIT:
  calls:
    - RRET
    - SOSCALLS
  code: |
    EXX
    POP HL
    LD (RETADR-2), HL
    EXX
    PUSH BC
    PUSH DE
    PUSH HL
    PUSH IX
    PUSH IY
    LD (RSP-2),SP

    LD A,(sWIDTH)
    LD (AT_WIDTH),A

    ; WORK ZERO CLEAR
    XOR A
    LD HL,__WORK__
    LD DE,__WORK__+1
    LD BC,__WORKEND__-__WORK__-1
    LD (HL),A
    LDIR

    ; SP=$0000
    DB 0,0,0

    <<CALLINITIALIZER>>

    CALL SEARCHCTC

    LD IY,__IYWORK

    CALL MAIN
    OR A

    RRET:
    LD SP,0
    RSP:
    POP IY
    POP IX
    POP HL
    POP DE
    POP BC
    JP $0000
    RETADR:

    ; CTC CHECK
    SEARCHCTC:
    LD	BC,0
    LD	(_CTC),BC
    LD	BC,00A04H
    CALL	CHKCTC
    LD	BC,00704H
    CALL	CHKCTC
    LD	BC,01FA8H
    CALL	CHKCTC
    LD	BC,01FA0H
    CALL	CHKCTC

    ; #VER
    ; Hレジスタ
    ; 機種別情報を元に割り込みベクタアドレスを決める
    ; 20H	Ｘ１ →0058H
    ; 21H	Ｘ１ｔｕｒｂｏ → F830H (IはF8のはずなのでいじらない……)
    ; 22H	Ｘ１（筑紫版） →0058H
    CALL 1FF7H
    LD A,H
    AND 0F0H
    CP 20H
    JR NZ,SETCTCADREND
    LD A,H
    CP 21H
    JR Z,CTCX1TURBO

    ; normal X1 S-OS or 筑紫版
    LD HL,0058H
    LD (_CTCVEC),HL
    JR SETCTCADREND

    CTCX1TURBO:
    ; X1turbo
    LD HL,F830H
    LD (_CTCVEC),HL
    SETCTCADREND:

    RET

    CHKCTC:
    PUSH	BC
    LD	DE,04703H
    INICTC1:
    INC	C
    OUT	(C),D
    DB	0EDH,071H	;OUT (C),0	Z80未定義命令
    DEC	E
    JR	NZ,INICTC1
    POP	BC

    LD	DE,007FAH
    OUT	(C),D
    OUT	(C),E
    IN	A,(C)
    CP	E
    RET	NZ
    OUT	(C),D
    OUT	(C),D
    IN	A,(C)
    CP	D
    RET	NZ
    INC	C
    INC	C
    LD	(_CTC),BC
    RET

STOP:
  param_count: 0
  code: |
    SCF
    JP RRET

SOSCALLS:
  code: |
    sLPTOF  EQU 1FD6H
    sLPTON  EQU 1FD9H
    sLPRNT  EQU 1FDCH
    sPRINT  EQU 1FF4H
    sWIDCH  EQU 2030H
    sSCRN   EQU 201BH
    sLOC    EQU 201EH
    sGETKY  EQU 1FD0H
    sFLGET  EQU 2021H
    sINKEY  EQU 1FCAH
    sCSR    EQU 2018H
    sGETL   EQU 1FD3H
    sHLHEX  EQU 1FB2H
    sKBFAD  EQU 1F76H

    sFILE   EQU 1FA3H
    sDSK    EQU 1F5DH
    sFATPOS EQU 1F5EH
    sDIRPS  EQU 1F60H
    sDTBUF  EQU 1F64H
    sIBFAD  EQU 1F74H
    sDRDSB  EQU 2000H
    sDWTSB  EQU 2003H

    sTPCHK  EQU 2863H

    sWIDTH  EQU 1F5CH
  works:
    AT_WIDTH: 1
    _CTC: 2
    _CTCVEC: 2

BEEP:
  code: |
    CALL $1FC4
    RET
